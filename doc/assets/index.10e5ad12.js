import{r as w,l as R,c as O,d as G,i as X,R as K,a as ae,o as E,b as d,e as C,w as B,f as k,g as M,h as v,u as c,L as A,B as P,F as T,G as Z,C as q,j as le,A as ie,T as ue,k as ce,M as de,m as x,n as N,p as H,q as W,t as j,s as J,v as pe,P as fe,S as ve,x as ye,H as me,y as _e,z as xe}from"./vendor.0eee3534.js";const ge=function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))t(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const m of a.addedNodes)m.tagName==="LINK"&&m.rel==="modulepreload"&&t(m)}).observe(document,{childList:!0,subtree:!0});function r(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerpolicy&&(a.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?a.credentials="include":n.crossorigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function t(n){if(n.ep)return;n.ep=!0;const a=r(n);fetch(n.href,a)}};ge();var b;(function(e){e.I="I",e.L="L",e.J="J",e.O="O",e.Z="Z",e.S="S",e.T="T"})(b||(b={}));const he=Object.freeze({[b.I]:[[0,1,0,0],[0,1,0,0],[0,1,0,0],[0,1,0,0]],[b.L]:[[0,2,0],[0,2,0],[0,2,2]],[b.J]:[[0,3,0],[0,3,0],[3,3,0]],[b.O]:[[4,4],[4,4]],[b.Z]:[[5,5,0],[0,5,5],[0,0,0]],[b.S]:[[0,6,6],[6,6,0],[0,0,0]],[b.T]:[[0,7,0],[7,7,7],[0,0,0]]});function Q(){return R.exports.sample(Object.values(b))}function Y(e){return R.exports.cloneDeep(he[e])}function ke(e){const s=[];return e.forEach((r,t)=>{r.forEach((n,a)=>{n!==0&&s.push({x:a,y:t,z:0})})}),s}function Ie(e,s){for(let r=0;r<e.length;++r)for(let t=0;t<r;++t)[e[t][r],e[r][t]]=[e[r][t],e[t][r]];return s>0?e.forEach(r=>r.reverse()):e.reverse(),e}const we=()=>{const e=w(Q()),s=w(Y(e.value)),r=O(()=>ke(s.value));return{setBlock:a=>{e.value=a!=null?a:Q(),s.value=Y(e.value)},rotateBlock:()=>s.value=Ie(s.value,1),blockPosition:r}},be=()=>{const e=w(0),s=w(350);let r=null;return{duration:s,isTimeUp:n=>{const a=r===null?0:n-r;return r=n,e.value>0?(e.value-=a,!1):(s.value-=.5,e.value=s.value,!0)}}},F=[{rotate:"w",left:"a",right:"d",speed:"s"},{rotate:"ArrowUp",left:"ArrowLeft",right:"ArrowRight",speed:"ArrowDown"}],Be=G({props:{playerIndex:null},emits:["gameover","score"],setup(e,{emit:s}){const{playerIndex:r}=e,t=X(K),n=w(),a=l=>{switch(console.log(l.key),l.key){case F[r].left:if(S.value.findIndex(i=>i.x<-4)!==-1)break;if(S.value.findIndex(i=>{var o,u;return((u=(o=I.value)==null?void 0:o[i.y])==null?void 0:u[i.x-1])===!0})!==-1){console.log(I);break}g.x-=1;break;case F[r].right:if(S.value.findIndex(i=>i.x>3)!==-1||S.value.findIndex(i=>{var o,u;return((u=(o=I.value)==null?void 0:o[i.y])==null?void 0:u[i.x+1])===!0})!==-1)break;g.x+=1;break;case F[r].speed:V();break;case F[r].rotate:_();break}},m=(l,i)=>{const o=[];for(let u=0;u<i;u++)o.push({x:l.x+u,y:l.y,z:l.z});return o};w([]);let g=ae({x:0,y:24,z:0}),h=w([]),I=O(()=>h.value.reduce((l,i)=>(R.exports.set(l,[i.y,i.x],!0),l),{}));const{duration:p,isTimeUp:f}=be(),{setBlock:y,rotateBlock:_,blockPosition:L}=we(),te=[...m({x:-5,y:-1,z:0},10)],S=O(()=>L.value.map(l=>({x:l.x+g.x,y:l.y+g.y,z:l.z+g.z}))),ne=O(()=>S.value.reduce((l,{x:i,y:o,z:u})=>(R.exports.set(l,[i,o],!0),l),{})),re=()=>S.value.findIndex(o=>o.y===0)!==-1||h.value.findIndex(o=>{var z,$;const u=($=(z=ne.value)==null?void 0:z[o.x])==null?void 0:$[o.y+1];return u!=null})!==-1,V=()=>{re()?(h.value.push(...S.value),y(null),g.y=24):g.y-=1},oe=()=>h.value.find(l=>l.y>20),se=()=>{const l=Object.entries(I.value),i=l.filter(([o,u])=>Object.keys(u).length===10).map(([o])=>parseInt(o));if(i.length>0){const o=l.filter(([u])=>!i.includes(parseInt(u))).reduce((u,[z])=>{const $=i.filter(D=>D<parseInt(z)).length;return u[z]=$,u},{});h.value=h.value.filter(({y:u})=>!i.includes(u)).map(({x:u,y:z,z:$})=>{var D;return{x:u,y:z-((D=o==null?void 0:o[z])!=null?D:0),z:$}}),s("score",i.length*10)}};return E(()=>{window.addEventListener("keydown",a);let l=!1;t==null||t.onBeforeRender(({time:i})=>{if(!l){if(oe()){l=!0,s("gameover");return}f(i)&&V(),se()}})}),(l,i)=>(d(),C(c(Z),{ref:(o,u)=>{u.tetris=o,n.value=o}},{default:B(()=>[(d(),k(T,null,M(te,o=>v(c(P),{key:o.x+"b"+e.playerIndex+o.y,position:o},{default:B(()=>[v(c(A),{props:{wireframe:!1}})]),_:2},1032,["position"])),64)),v(c(P),{position:{x:5,y:10},scale:{y:23}},{default:B(()=>[v(c(A),{props:{wireframe:!1}})]),_:1}),v(c(P),{position:{x:-6,y:10},scale:{y:23}},{default:B(()=>[v(c(A),{props:{wireframe:!1}})]),_:1}),(d(!0),k(T,null,M(c(S),o=>(d(),C(c(P),{key:o.x+"p"+e.playerIndex+o.y,position:o},{default:B(()=>[v(c(A),{props:{color:"red"}})]),_:2},1032,["position"]))),128)),(d(!0),k(T,null,M(c(h),o=>(d(),C(c(P),{key:o.x+"f"+e.playerIndex+o.y,position:o},{default:B(()=>[v(c(A),{props:{wireframe:!0}})]),_:2},1032,["position"]))),128))]),_:1},512))}}),Se=G({props:{playerIndex:null,animationState:null},emits:["loadComplete"],setup(e,{emit:s}){const{playerIndex:r}=e,t=X(K);let n=null;const a=m=>{n=new ie(m);const g=new ue,h=new ce;let I=null;g.loadAsync(`player${r+1}.png`).then(p=>{const f=new de({map:p});m.traverse(y=>{y.isMesh&&(y.material=f)})}),h.setPath("/"),Promise.all(["Victory","Idle","Punch","Defeat"].map(p=>h.loadAsync(`${p}.fbx`).then(f=>({name:p,anim:f})))).then(p=>{I=p.reduce((y,{name:_,anim:L})=>(y[_]={animation:L.animations[0],duration:L.animations[0].duration},y),{}),n.clipAction(I.Idle.animation).play()})};return E(()=>{const m=new q;t==null||t.onBeforeRender(()=>{n==null||n.update(m.getDelta())})}),(m,g)=>(d(),C(c(le),{src:"/Model.fbx",scale:{x:.03,y:.03,z:.03},onLoad:a},null,8,["scale"]))}});var U=(e,s)=>{for(const[r,t]of s)e[r]=t;return e};const ee=e=>(H("data-v-991f1792"),e=e(),W(),e),ze={class:"start-game"},Ce=ee(()=>x("h1",null,"Tetris with TroisJS",-1)),Le={class:"menu"},Te=ee(()=>x("a",{class:"nes-btn spacing",href:"https://github.com/RingoKam/trois-tetris"},"<Source Code>",-1)),$e=G({emits:["start-game"],setup(e,{emit:s}){return(r,t)=>(d(),k("div",ze,[Ce,x("div",Le,[x("button",{type:"button",class:"nes-btn is-primary spacing",onClick:t[0]||(t[0]=N(n=>s("start-game",1),["prevent"]))}," Start Game 1P "),x("button",{type:"button",class:"nes-btn is-error spacing",onClick:t[1]||(t[1]=N(n=>s("start-game",2),["prevent"]))}," Start Game 2P "),Te])]))}});var Ge=U($e,[["__scopeId","data-v-991f1792"]]);const Me={class:"on-going"},Oe=G({props:{players:null},setup(e){return(s,r)=>(d(),k("div",Me,[(d(!0),k(T,null,M(e.players,(t,n)=>(d(),k("div",{key:n}," Player_"+j(n+1)+": "+j(t),1))),128))]))}});var Ae=U(Oe,[["__scopeId","data-v-4b7f5361"]]);const Pe=e=>(H("data-v-3c685072"),e=e(),W(),e),De={class:"end-game"},Re=Pe(()=>x("h1",null,"Gameover...",-1)),je={class:"menu"},Fe={class:"nes-table-responsive spacing"},Ee=G({props:{players:null},emits:["backToMenu"],setup(e,{emit:s}){return(r,t)=>(d(),k("div",De,[Re,x("div",je,[x("div",Fe,[x("tbody",null,[(d(!0),k(T,null,M(e.players,(n,a)=>(d(),k("tr",{key:a},[x("td",null,"player_"+j(a+1)+": ",1),x("td",null,j(n),1)]))),128))])]),x("button",{type:"button",class:"nes-btn is-error spacing",onClick:t[0]||(t[0]=N(n=>s("backToMenu"),["prevent"]))}," Back to Menu ")])]))}});var Ne=U(Ee,[["__scopeId","data-v-3c685072"]]);const Je={class:"overlay"},Ue=G({setup(e){const s=w(),r=w("start"),t=w([]),n=O(()=>t.value.length===2?{0:-15,1:15}:{0:0}),a=p=>{t.value=new Array(p).fill(0),r.value="ongoing"},m=(p,f)=>{t.value[f]+=p},g=()=>{r.value="end"},h=()=>{t.value=[],r.value="start"};let I=null;return E(()=>{pe.enabled=!0;const p=s.value,f=new q;p==null||p.onBeforeRender(()=>{I==null||I.update(f.getDelta())})}),(p,f)=>(d(),k(T,null,[x("div",Je,[r.value==="start"?(d(),C(Ge,{key:0,onStartGame:f[0]||(f[0]=y=>a(y))})):J("",!0),r.value==="ongoing"?(d(),C(Ae,{key:1,players:t.value},null,8,["players"])):J("",!0),r.value==="end"?(d(),C(Ne,{key:2,players:t.value,onBackToMenu:f[1]||(f[1]=y=>h())},null,8,["players"])):J("",!0)]),v(c(_e),{ref:(y,_)=>{_.rendererC=y,s.value=y},antialias:"",resize:"window"},{default:B(()=>[v(c(fe),{position:{z:10}}),v(c(ve),null,{default:B(()=>[v(c(ye),{position:{y:50,z:50}}),v(c(me)),(d(!0),k(T,null,M(t.value,(y,_)=>(d(),C(c(Z),{key:_,position:{x:c(n)[_],y:-10,z:-40}},{default:B(()=>[v(Be,{playerIndex:_,onGameover:f[2]||(f[2]=L=>g()),onScore:L=>m(L,_)},null,8,["playerIndex","onScore"]),v(Se,{playerIndex:_,animationState:"idle",position:{x:_==0?10:-10},rotation:{x:0,y:_==0?t.value.length==1?0:.4:-.4,z:0}},null,8,["playerIndex","position","rotation"])]),_:2},1032,["position"]))),128))]),_:1})]),_:1},512)],64))}});xe(Ue).mount("#app");
