import{r as I,l as j,c as O,d as G,i as K,R as Z,a as ae,o as N,b as d,e as C,w as B,f as h,g as M,h as y,u as c,L as P,B as A,F as $,G as q,C as H,j as le,A as ie,T as ue,k as ce,M as de,m as x,n as J,p as W,q as Q,t as F,s as U,v as pe,P as fe,S as ve,x as ye,H as me,y as _e,z as xe}from"./vendor.0eee3534.js";const ge=function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))t(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const b of a.addedNodes)b.tagName==="LINK"&&b.rel==="modulepreload"&&t(b)}).observe(document,{childList:!0,subtree:!0});function n(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerpolicy&&(a.referrerPolicy=r.referrerpolicy),r.crossorigin==="use-credentials"?a.credentials="include":r.crossorigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function t(r){if(r.ep)return;r.ep=!0;const a=n(r);fetch(r.href,a)}};ge();var w;(function(e){e.I="I",e.L="L",e.J="J",e.O="O",e.Z="Z",e.S="S",e.T="T"})(w||(w={}));const he=Object.freeze({[w.I]:[[0,1,0,0],[0,1,0,0],[0,1,0,0],[0,1,0,0]],[w.L]:[[0,2,0],[0,2,0],[0,2,2]],[w.J]:[[0,3,0],[0,3,0],[3,3,0]],[w.O]:[[4,4],[4,4]],[w.Z]:[[5,5,0],[0,5,5],[0,0,0]],[w.S]:[[0,6,6],[6,6,0],[0,0,0]],[w.T]:[[0,7,0],[7,7,7],[0,0,0]]});function Y(){return j.exports.sample(Object.values(w))}function ee(e){return j.exports.cloneDeep(he[e])}function ke(e){const s=[];return e.forEach((n,t)=>{n.forEach((r,a)=>{r!==0&&s.push({x:a,y:t,z:0})})}),s}function Ie(e,s){for(let n=0;n<e.length;++n)for(let t=0;t<n;++t)[e[t][n],e[n][t]]=[e[n][t],e[t][n]];return s>0?e.forEach(n=>n.reverse()):e.reverse(),e}const we=()=>{const e=I(Y()),s=I(ee(e.value)),n=O(()=>ke(s.value));return{setBlock:a=>{e.value=a!=null?a:Y(),s.value=ee(e.value)},rotateBlock:()=>s.value=Ie(s.value,1),blockPosition:n}},be=()=>{const e=I(0),s=I(350);let n=null;return{duration:s,isTimeUp:r=>{const a=n===null?0:r-n;return n=r,e.value>0?(e.value-=a,!1):(s.value-=.5,e.value=s.value,!0)}}},E=[{rotate:"w",left:"a",right:"d",speed:"s"},{rotate:"ArrowUp",left:"ArrowLeft",right:"ArrowRight",speed:"ArrowDown"}],Be=G({props:{playerIndex:null},emits:["gameover","score"],setup(e,{emit:s}){const{playerIndex:n}=e,t=K(Z),r=I(),a=l=>{switch(console.log(l.key),l.key){case E[n].left:if(S.value.findIndex(i=>i.x<-4)!==-1)break;if(S.value.findIndex(i=>{var o,u;return((u=(o=k.value)==null?void 0:o[i.y])==null?void 0:u[i.x-1])===!0})!==-1){console.log(k);break}v.x-=1;break;case E[n].right:if(S.value.findIndex(i=>i.x>3)!==-1||S.value.findIndex(i=>{var o,u;return((u=(o=k.value)==null?void 0:o[i.y])==null?void 0:u[i.x+1])===!0})!==-1)break;v.x+=1;break;case E[n].speed:X();break;case E[n].rotate:f();break}},b=(l,i)=>{const o=[];for(let u=0;u<i;u++)o.push({x:l.x+u,y:l.y,z:l.z});return o};I([]);let v=ae({x:0,y:24,z:0}),g=I([]),k=O(()=>g.value.reduce((l,i)=>(j.exports.set(l,[i.y,i.x],!0),l),{}));const{duration:m,isTimeUp:p}=be(),{setBlock:_,rotateBlock:f,blockPosition:L}=we(),D=[...b({x:-5,y:-1,z:0},10)],S=O(()=>L.value.map(l=>({x:l.x+v.x,y:l.y+v.y,z:l.z+v.z}))),ne=O(()=>S.value.reduce((l,{x:i,y:o,z:u})=>(j.exports.set(l,[i,o],!0),l),{})),re=()=>S.value.findIndex(o=>o.y===0)!==-1||g.value.findIndex(o=>{var z,T;const u=(T=(z=ne.value)==null?void 0:z[o.x])==null?void 0:T[o.y+1];return u!=null})!==-1,X=()=>{re()?(g.value.push(...S.value),_(null),v.y=24):v.y-=1},oe=()=>g.value.find(l=>l.y>20),se=()=>{const l=Object.entries(k.value),i=l.filter(([o,u])=>Object.keys(u).length===10).map(([o])=>parseInt(o));if(i.length>0){const o=l.filter(([u])=>!i.includes(parseInt(u))).reduce((u,[z])=>{const T=i.filter(R=>R<parseInt(z)).length;return u[z]=T,u},{});g.value=g.value.filter(({y:u})=>!i.includes(u)).map(({x:u,y:z,z:T})=>{var R;return{x:u,y:z-((R=o==null?void 0:o[z])!=null?R:0),z:T}}),s("score",i.length*10)}};return N(()=>{window.addEventListener("keydown",a);let l=!1;t==null||t.onBeforeRender(({time:i})=>{if(!l){if(oe()){l=!0,s("gameover");return}p(i)&&X(),se()}})}),(l,i)=>(d(),C(c(q),{ref:(o,u)=>{u.tetris=o,r.value=o}},{default:B(()=>[(d(),h($,null,M(D,o=>y(c(A),{key:o.x+"b"+e.playerIndex+o.y,position:o},{default:B(()=>[y(c(P),{props:{wireframe:!1}})]),_:2},1032,["position"])),64)),y(c(A),{position:{x:5,y:10},scale:{y:23}},{default:B(()=>[y(c(P),{props:{wireframe:!1}})]),_:1}),y(c(A),{position:{x:-6,y:10},scale:{y:23}},{default:B(()=>[y(c(P),{props:{wireframe:!1}})]),_:1}),(d(!0),h($,null,M(c(S),o=>(d(),C(c(A),{key:o.x+"p"+e.playerIndex+o.y,position:o},{default:B(()=>[y(c(P),{props:{color:"red"}})]),_:2},1032,["position"]))),128)),(d(!0),h($,null,M(c(g),o=>(d(),C(c(A),{key:o.x+"f"+e.playerIndex+o.y,position:o},{default:B(()=>[y(c(P),{props:{wireframe:!0}})]),_:2},1032,["position"]))),128))]),_:1},512))}}),Se=G({props:{playerIndex:null,animationState:null},emits:["loadComplete"],setup(e,{emit:s}){const{playerIndex:n}=e,t="/trois-tetris",r=K(Z);let a=null;const b=v=>{a=new ie(v);const g=new ue,k=new ce;let m=null;g.loadAsync(`.${t}/player${n+1}.png`).then(p=>{const _=new de({map:p});v.traverse(f=>{f.isMesh&&(f.material=_)})}),k.setPath("/"),Promise.all(["Victory","Idle","Punch","Defeat"].map(p=>k.loadAsync(`.${t}/${p}.fbx`).then(_=>({name:p,anim:_})))).then(p=>{m=p.reduce((f,{name:L,anim:D})=>(f[L]={animation:D.animations[0],duration:D.animations[0].duration},f),{}),a.clipAction(m.Idle.animation).play()})};return N(()=>{const v=new H;r==null||r.onBeforeRender(()=>{a==null||a.update(v.getDelta())})}),(v,g)=>(d(),C(c(le),{src:c(t)+"/Model.fbx",scale:{x:.03,y:.03,z:.03},onLoad:b},null,8,["src","scale"]))}});var V=(e,s)=>{for(const[n,t]of s)e[n]=t;return e};const te=e=>(W("data-v-991f1792"),e=e(),Q(),e),ze={class:"start-game"},Ce=te(()=>x("h1",null,"Tetris with TroisJS",-1)),$e={class:"menu"},Le=te(()=>x("a",{class:"nes-btn spacing",href:"https://github.com/RingoKam/trois-tetris"},"<Source Code>",-1)),Te=G({emits:["start-game"],setup(e,{emit:s}){return(n,t)=>(d(),h("div",ze,[Ce,x("div",$e,[x("button",{type:"button",class:"nes-btn is-primary spacing",onClick:t[0]||(t[0]=J(r=>s("start-game",1),["prevent"]))}," Start Game 1P "),x("button",{type:"button",class:"nes-btn is-error spacing",onClick:t[1]||(t[1]=J(r=>s("start-game",2),["prevent"]))}," Start Game 2P "),Le])]))}});var Ge=V(Te,[["__scopeId","data-v-991f1792"]]);const Me={class:"on-going"},Oe=G({props:{players:null},setup(e){return(s,n)=>(d(),h("div",Me,[(d(!0),h($,null,M(e.players,(t,r)=>(d(),h("div",{key:r}," Player_"+F(r+1)+": "+F(t),1))),128))]))}});var Pe=V(Oe,[["__scopeId","data-v-4b7f5361"]]);const Ae=e=>(W("data-v-3c685072"),e=e(),Q(),e),De={class:"end-game"},Re=Ae(()=>x("h1",null,"Gameover...",-1)),je={class:"menu"},Fe={class:"nes-table-responsive spacing"},Ee=G({props:{players:null},emits:["backToMenu"],setup(e,{emit:s}){return(n,t)=>(d(),h("div",De,[Re,x("div",je,[x("div",Fe,[x("tbody",null,[(d(!0),h($,null,M(e.players,(r,a)=>(d(),h("tr",{key:a},[x("td",null,"player_"+F(a+1)+": ",1),x("td",null,F(r),1)]))),128))])]),x("button",{type:"button",class:"nes-btn is-error spacing",onClick:t[0]||(t[0]=J(r=>s("backToMenu"),["prevent"]))}," Back to Menu ")])]))}});var Ne=V(Ee,[["__scopeId","data-v-3c685072"]]);const Je={class:"overlay"},Ue=G({setup(e){const s=I(),n=I("start"),t=I([]),r=O(()=>t.value.length===2?{0:-15,1:15}:{0:0}),a=m=>{t.value=new Array(m).fill(0),n.value="ongoing"},b=(m,p)=>{t.value[p]+=m},v=()=>{n.value="end"},g=()=>{t.value=[],n.value="start"};let k=null;return N(()=>{pe.enabled=!0;const m=s.value,p=new H;m==null||m.onBeforeRender(()=>{k==null||k.update(p.getDelta())})}),(m,p)=>(d(),h($,null,[x("div",Je,[n.value==="start"?(d(),C(Ge,{key:0,onStartGame:p[0]||(p[0]=_=>a(_))})):U("",!0),n.value==="ongoing"?(d(),C(Pe,{key:1,players:t.value},null,8,["players"])):U("",!0),n.value==="end"?(d(),C(Ne,{key:2,players:t.value,onBackToMenu:p[1]||(p[1]=_=>g())},null,8,["players"])):U("",!0)]),y(c(_e),{ref:(_,f)=>{f.rendererC=_,s.value=_},antialias:"",resize:"window"},{default:B(()=>[y(c(fe),{position:{z:10}}),y(c(ve),null,{default:B(()=>[y(c(ye),{position:{y:50,z:50}}),y(c(me)),(d(!0),h($,null,M(t.value,(_,f)=>(d(),C(c(q),{key:f,position:{x:c(r)[f],y:-10,z:-40}},{default:B(()=>[y(Be,{playerIndex:f,onGameover:p[2]||(p[2]=L=>v()),onScore:L=>b(L,f)},null,8,["playerIndex","onScore"]),y(Se,{playerIndex:f,animationState:"idle",position:{x:f==0?10:-10},rotation:{x:0,y:f==0?t.value.length==1?0:.4:-.4,z:0}},null,8,["playerIndex","position","rotation"])]),_:2},1032,["position"]))),128))]),_:1})]),_:1},512)],64))}});xe(Ue).mount("#app");
